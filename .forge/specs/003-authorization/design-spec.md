# Design Spec: Authorization System (RBAC + ABAC)

> **Spec reference**: `.forge/specs/003-authorization/spec.md`
> **Generated by**: `/forge-ux`
> **Date**: 2026-02-22
> **Status**: Draft

---

## 1. Overview

| Field         | Value                                                               |
| ------------- | ------------------------------------------------------------------- |
| Feature       | Authorization System (RBAC + ABAC)                                  |
| Spec ID       | 003-authorization                                                   |
| Platform      | Web SPA (React + TanStack Router + Vite)                            |
| Viewports     | Desktop (1440px primary), Tablet (1024px), Responsive floor (768px) |
| Design system | Tailwind CSS + `@plexica/ui` + semantic CSS custom properties       |
| FRs covered   | FR-001 through FR-024                                               |

---

## 2. Screen Inventory

| #   | Screen Name               | Entry Point                                       | Primary User Action                      | FR Ref                         | Status |
| --- | ------------------------- | ------------------------------------------------- | ---------------------------------------- | ------------------------------ | ------ |
| 1   | Role List                 | Sidebar > Access Control > Roles                  | View/filter all roles                    | FR-003, FR-004, FR-023         | New    |
| 2   | Role Editor (Create/Edit) | Role List > "Create Role" / Row > "Edit"          | Define permissions for a role            | FR-005, FR-020, FR-021         | New    |
| 3   | Role Detail               | Role List > Row click                             | View role permissions and assigned users | FR-003, FR-006                 | New    |
| 4   | User Role Assignment      | Role List > Users tab / User row > "Manage Roles" | Assign/remove roles for a user           | FR-006, FR-018, FR-019         | New    |
| 5   | ABAC Policy List          | Sidebar > Access Control > Policies               | View/filter all ABAC policies            | FR-007, FR-009, FR-017         | New    |
| 6   | ABAC Policy Editor        | Policy List > "Create Policy" / Row > "Edit"      | Define ABAC conditions                   | FR-008, FR-014, FR-015, FR-022 | New    |

---

## 3. Wireframes

### Screen 1: Role List

**Source**: FR-003, FR-004, FR-005, FR-023 | **Type**: New

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  Roles                                           [+ Create Role]
| BAR    |  Manage roles and permissions for your team                   |
|        |                                                               |
|--------|  [ğŸ” Search roles...____________________]  [Source â–¾] [Type â–¾]|
| Dash   |                                                               |
| -----  |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
| Access |  â”‚ NAME              â”‚ TYPE    â”‚ PERMISSIONS â”‚ USERS â”‚     â”‚  |
| Control|  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  |
|  Rolesâ—„|  â”‚ ğŸ”’ Super Admin    â”‚ System  â”‚ *:* (all)   â”‚  1    â”‚     â”‚  |
|  Users |  â”‚ ğŸ”’ Tenant Admin   â”‚ System  â”‚ 12          â”‚  3    â”‚     â”‚  |
|  Polici|  â”‚ ğŸ”’ Team Admin     â”‚ System  â”‚ 8           â”‚  5    â”‚     â”‚  |
|  -----  |  â”‚ ğŸ”’ User           â”‚ System  â”‚ 4           â”‚  32   â”‚     â”‚  |
| Plugin |  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  |
| -----  |  â”‚ Sales Manager     â”‚ Custom  â”‚ 5           â”‚  8    â”‚ â‹®   â”‚  |
| Settin |  â”‚ CRM Viewer        â”‚ Custom  â”‚ 3           â”‚  4    â”‚ â‹®   â”‚  |
|        |  â”‚ Support Agent      â”‚ Custom  â”‚ 7           â”‚  12   â”‚ â‹®   â”‚  |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜  |
|        |                                                               |
|        |  Custom roles: 3 of 50                    [â—€ 1 2 3 ... â–¶]    |
+--------+---------------------------------------------------------------+
```

**Key design decisions**:

- System roles (FR-004) displayed first with a ğŸ”’ lock icon and "System" badge (FR-023).
- System role rows have no action menu (â‹®) â€” edit/delete disabled per FR-004.
- Custom roles have action menu with: Edit, Duplicate, Delete.
- "Custom roles: 3 of 50" counter communicates the FR-005 limit.

**Tablet (1024px)**:

```
+------------------------------------------------------------------+
| â‰¡ Plexica                                     [?] [ğŸ””] [User â–¾] |
+------------------------------------------------------------------+
|                                                                   |
|  Roles                                           [+ Create Role] |
|  [ğŸ” Search...____________]  [Source â–¾] [Type â–¾]                 |
|                                                                   |
|  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   |
|  â”‚ NAME             â”‚ TYPE    â”‚ PERMS â”‚ USERS â”‚               â”‚   |
|  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   |
|  â”‚ ğŸ”’ Super Admin   â”‚ System  â”‚ All   â”‚  1    â”‚               â”‚   |
|  â”‚ ğŸ”’ Tenant Admin  â”‚ System  â”‚ 12    â”‚  3    â”‚               â”‚   |
|  â”‚ Sales Manager    â”‚ Custom  â”‚ 5     â”‚  8    â”‚       â‹®       â”‚   |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   |
|                                                                   |
|  Custom roles: 3/50                            [â—€ 1 2 3 â–¶]      |
+------------------------------------------------------------------+
```

#### State Inventory

| State    | Trigger                             | Visual Change                                                                                                                                                  | User Feedback  |
| -------- | ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| Default  | Page load, roles exist              | Data table with rows                                                                                                                                           | â€”              |
| Loading  | Initial page load                   | Skeleton rows (3-5 rows of skeleton lines)                                                                                                                     | â€”              |
| Error    | API failure (GET /api/v1/roles)     | Alert banner (destructive): "Failed to load roles. Please try again." + [Retry] button                                                                         | Error toast    |
| Empty    | No custom roles, only system roles  | System roles shown. Below: EmptyState: "No custom roles yet. Create a custom role to define specific permissions for your team." CTA: "Create Your First Role" | â€”              |
| Success  | After role create/delete            | Toast: "Role created/deleted successfully." Table refreshes.                                                                                                   | Success toast  |
| Disabled | "Create Role" when 50 roles reached | Button disabled. Tooltip: "Custom role limit reached (50/50)." Warning banner at top.                                                                          | Warning banner |

#### Interactive Elements

| Element            | Type                    | Action | Outcome                                            |
| ------------------ | ----------------------- | ------ | -------------------------------------------------- |
| Create Role        | Button (primary)        | Click  | Navigate to Role Editor (create mode)              |
| Search input       | Input                   | Type   | Filter role list in real-time (client-side)        |
| Source filter      | Select dropdown         | Select | Filter by Core / Plugin name                       |
| Type filter        | Select dropdown         | Select | Filter by System / Custom                          |
| Role row (system)  | Table row               | Click  | Navigate to Role Detail (read-only)                |
| Role row (custom)  | Table row               | Click  | Navigate to Role Detail                            |
| Action menu (â‹®)    | Dropdown button         | Click  | Shows: Edit, Duplicate, Delete                     |
| Edit (menu item)   | Menu item               | Click  | Navigate to Role Editor (edit mode)                |
| Delete (menu item) | Menu item (destructive) | Click  | Confirmation dialog, then DELETE /api/v1/roles/:id |
| Pagination         | Pagination component    | Click  | Load next/prev page                                |

#### Responsive Notes

- **1440px**: Full table with all columns. Sidebar visible (w-60).
- **1024px**: Sidebar collapsed (w-16). "PERMISSIONS" column abbreviated to "PERMS".
- **768px**: Sidebar hidden (hamburger menu). Table becomes card layout â€” each role as a card showing name, type badge, permission count, user count, and action button.

#### Accessibility

```
Role: main
Heading hierarchy: h1 "Roles" â†’ h2 (none, flat list)
Tab order: [1] Search â†’ [2] Source filter â†’ [3] Type filter â†’ [4] Create Role â†’
           [5..N] Table rows (roving tabindex) â†’ [N+1] Pagination
Focus trap: No

ARIA:
  Search input: aria-label="Search roles by name"
  DataTable: role="table", aria-label="Roles list"
  System role lock icon: aria-label="System role (cannot be modified)"
  Action menu button: aria-label="Actions for {roleName}"
  Action menu: role="menu"
  Create Role (disabled): aria-disabled="true", aria-describedby="role-limit-warning"

Contrast:
  Body text on background: --foreground on --background = 17.4:1 âœ“
  Muted text (permission count): --muted-foreground on --background = 4.7:1 âœ“
  System badge text: --primary-foreground on --primary = 5.3:1 âœ“
  Lock icon on background: --muted-foreground on --background = 4.7:1 âœ“

Keyboard:
  Enter: Activate focused row (navigate to detail) or activate focused button
  Space: Toggle checkbox / activate button
  Esc: Close action menu dropdown
  Arrow Up/Down: Navigate table rows (roving tabindex)

Screen reader flow:
  1. "Roles, heading level 1"
  2. "Search roles by name, search input"
  3. "Roles list, table, 7 rows"
  4. "Row 1: Super Admin, System role, all permissions, 1 user"
  5. "Row 5: Sales Manager, Custom role, 5 permissions, 8 users, actions available"
```

---

### Screen 2: Role Editor (Create / Edit)

**Source**: FR-005, FR-020, FR-021 | **Type**: New

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  â† Back to Roles                                             |
| BAR    |                                                               |
|        |  Create Role              [mode: CREATE | EDIT "{roleName}"]  |
|        |  Define permissions for this role                             |
|--------|                                                               |
|        |  â”Œâ”€ Role Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Name *        [Sales Manager________________] âœ“         â”‚ |
|        |  â”‚  Description   [Access to CRM contacts and deals________]â”‚ |
|        |  â”‚                [_________________________________________]â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |  â”Œâ”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Selected: 5 â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  [ğŸ” Search permissions..._______________________]       â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â–¼ Core                                          2 of 8  â”‚ |
|        |  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ |
|        |  â”‚  â”‚ â˜‘ workspaces:read     View workspaces               â”‚â”‚ |
|        |  â”‚  â”‚ â˜ workspaces:write    Create/edit workspaces        â”‚â”‚ |
|        |  â”‚  â”‚ â˜‘ users:read          View user profiles            â”‚â”‚ |
|        |  â”‚  â”‚ â˜ users:write         Manage users                  â”‚â”‚ |
|        |  â”‚  â”‚ â˜ roles:read          View roles                    â”‚â”‚ |
|        |  â”‚  â”‚ â˜ roles:write         Manage roles                  â”‚â”‚ |
|        |  â”‚  â”‚ â˜ policies:read       View access policies          â”‚â”‚ |
|        |  â”‚  â”‚ â˜ policies:write      Manage access policies        â”‚â”‚ |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â–¼ CRM (plugin)                                  3 of 6  â”‚ |
|        |  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ |
|        |  â”‚  â”‚ â˜‘ âœ¦ crm:deals:*       All deal actions (wildcard)   â”‚â”‚ |
|        |  â”‚  â”‚   â”œ â˜‘ crm:deals:read    View deals                  â”‚â”‚ |
|        |  â”‚  â”‚   â”œ â˜‘ crm:deals:write   Create/edit deals           â”‚â”‚ |
|        |  â”‚  â”‚   â”” â˜‘ crm:deals:delete  Delete deals                â”‚â”‚ |
|        |  â”‚  â”‚ â˜‘ crm:contacts:read   View contacts                 â”‚â”‚ |
|        |  â”‚  â”‚ â˜‘ crm:contacts:write  Create/edit contacts          â”‚â”‚ |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â–¶ HR (plugin)                                   0 of 4  â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |  â”Œâ”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚  5 permissions selected across 2 groups                  â”‚ |
|        |  â”‚  Core: workspaces:read, users:read                       â”‚ |
|        |  â”‚  CRM: crm:deals:* (3), crm:contacts:read,               â”‚ |
|        |  â”‚       crm:contacts:write                                 â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |         [ Cancel ]                          [ Save Role ]    |
+--------+---------------------------------------------------------------+
```

**Key design decisions**:

- Permission groups are collapsible accordion sections labeled by source (FR-020): "Core" and each plugin name.
- Wildcard permissions (FR-021): checking `crm:deals:*` auto-selects all sub-permissions. The wildcard checkbox is marked with a âœ¦ icon. Sub-permissions are indented with tree lines (â”œ â””).
- Unchecking any sub-permission unchecks the wildcard (per FR-021 acceptance criteria).
- Permission search filters across all groups, expanding matching groups.
- Summary section at bottom shows selected permissions grouped by source for review before save.
- In edit mode, title changes to "Edit Role: {roleName}". System roles cannot reach this screen (enforced by disabled Edit button + API guard).

**Tablet (1024px)**:

```
+------------------------------------------------------------------+
| â‰¡ Plexica                                     [?] [ğŸ””] [User â–¾] |
+------------------------------------------------------------------+
|  â† Back to Roles                                                  |
|                                                                    |
|  Create Role                                                       |
|                                                                    |
|  â”Œâ”€ Role Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   |
|  â”‚ Name *      [Sales Manager___________________] âœ“           â”‚   |
|  â”‚ Description [Access to CRM contacts...________]            â”‚   |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   |
|                                                                    |
|  â”Œâ”€ Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Selected: 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   |
|  â”‚ [ğŸ” Search permissions..._______]                          â”‚   |
|  â”‚                                                             â”‚   |
|  â”‚ â–¼ Core                                             2 of 8  â”‚   |
|  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   |
|  â”‚ â”‚ â˜‘ workspaces:read    View workspaces                 â”‚   â”‚   |
|  â”‚ â”‚ â˜ workspaces:write   Create/edit workspaces          â”‚   â”‚   |
|  â”‚ â”‚ ...                                                   â”‚   â”‚   |
|  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   |
|                                                                    |
|  â”Œâ”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   |
|  â”‚ 5 permissions across 2 groups                              â”‚   |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   |
|                                                                    |
|   [ Cancel ]                                      [ Save Role ]   |
+------------------------------------------------------------------+
```

#### State Inventory

| State            | Trigger                       | Visual Change                                                                           | User Feedback   |
| ---------------- | ----------------------------- | --------------------------------------------------------------------------------------- | --------------- |
| Default (create) | "Create Role" clicked         | Empty form, all checkboxes unchecked, "Selected: 0"                                     | â€”               |
| Default (edit)   | "Edit" clicked on custom role | Form pre-filled with role data, checkboxes reflect current permissions                  | â€”               |
| Loading          | Save clicked                  | "Save Role" button shows spinner, form disabled                                         | â€”               |
| Error (name)     | Name is empty or duplicate    | Red border on name input, inline error: "Role name is required" / "Name already exists" | Inline error    |
| Error (API)      | Save fails                    | Alert banner: "Failed to save role. Please try again." Form stays editable.             | Error toast     |
| Success          | Save succeeds                 | Toast: "Role '{name}' created/updated successfully." Redirect to Role Detail.           | Success toast   |
| Wildcard active  | Wildcard checkbox checked     | All sub-permissions auto-checked, indented with tree lines                              | Visual grouping |

#### Interactive Elements

| Element                 | Type               | Action | Outcome                                                                                                        |
| ----------------------- | ------------------ | ------ | -------------------------------------------------------------------------------------------------------------- |
| Back to Roles           | Link               | Click  | Navigate to Role List                                                                                          |
| Name input              | Input              | Type   | Real-time uniqueness validation (debounced 300ms)                                                              |
| Description input       | Textarea           | Type   | Free text, optional                                                                                            |
| Permission search       | Input              | Type   | Filter permissions across all groups                                                                           |
| Permission group header | Accordion trigger  | Click  | Expand/collapse group section                                                                                  |
| Permission checkbox     | Checkbox           | Click  | Toggle permission; update "Selected" count                                                                     |
| Wildcard checkbox (âœ¦)   | Checkbox           | Click  | Check: auto-select all sub-permissions. Uncheck: deselect all sub-permissions (per FR-021)                     |
| Sub-permission checkbox | Checkbox           | Click  | Toggle individual. If all sub-perms now checked, auto-check wildcard. If any unchecked, auto-uncheck wildcard. |
| Cancel                  | Button (secondary) | Click  | Navigate back (with unsaved changes warning if dirty)                                                          |
| Save Role               | Button (primary)   | Click  | POST/PUT /api/v1/roles, trigger cache flush (FR-019)                                                           |

#### Accessibility

```
Role: form
Heading hierarchy: h1 "Create Role" or "Edit Role: {name}" â†’ h2 "Role Details" â†’ h2 "Permissions" â†’ h2 "Summary"
Tab order: [1] Back link â†’ [2] Name input â†’ [3] Description input â†’ [4] Perm search â†’
           [5] First group toggle â†’ [6..N] Checkboxes â†’ [N+1] Cancel â†’ [N+2] Save
Focus trap: No

ARIA:
  Name input: aria-required="true", aria-describedby="name-error" (when invalid),
              aria-invalid="true" (when error)
  Permission search: aria-label="Search permissions"
  Permission group: role="group", aria-labelledby="group-{source}-heading"
  Group heading button: aria-expanded="true/false", aria-controls="group-{source}-panel"
  Wildcard checkbox: aria-label="Grant all {resource} permissions (wildcard)"
  Sub-permission checkboxes: aria-label="{key}: {description}"
  Summary section: aria-live="polite" (updates on permission changes)
  Save button: aria-disabled="true" when form invalid

Contrast:
  All text on card backgrounds: --foreground on --card = 17.4:1 âœ“
  Checkbox borders: --border on --card = meets 3:1 âœ“
  Selected count badge: --primary-foreground on --primary = 5.3:1 âœ“
  Error text: --destructive on --card = 5.8:1 âœ“

Keyboard:
  Tab: Move between form fields, group toggles, and checkboxes
  Space: Toggle checkbox / expand-collapse accordion
  Enter: Activate buttons (Cancel, Save)
  Esc: Dismiss unsaved changes dialog if shown
  Arrow Up/Down: Navigate within checkbox group

Screen reader flow:
  1. "Create Role, heading level 1"
  2. "Role Details, heading level 2"
  3. "Name, required, text input" â†’ (on error) "Name, required, invalid, Role name is required"
  4. "Permissions, heading level 2, 5 selected"
  5. "Core permissions, group, expanded, 2 of 8 selected"
  6. "workspaces:read, View workspaces, checkbox, checked"
  7. "CRM plugin permissions, group, expanded, 3 of 6 selected"
  8. "crm:deals:*, All deal actions wildcard, checkbox, checked"
  9. "Summary, heading level 2, 5 permissions selected across 2 groups" (aria-live update)
```

---

### Screen 3: Role Detail

**Source**: FR-003, FR-006, FR-023 | **Type**: New

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  â† Back to Roles                                             |
| BAR    |                                                               |
|        |  Sales Manager                          [Edit Role] [Delete]  |
|        |  Custom Role Â· Created Jan 15, 2026                           |
|        |  Access to CRM contacts and deals.                            |
|--------|                                                               |
|        |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
|        |  â”‚  [Permissions]  [Users (8)]                            â”‚  |
|        |  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  Core                                                   â”‚  |
|        |  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  |
|        |  â”‚  â”‚ workspaces:read   View workspaces                 â”‚ â”‚  |
|        |  â”‚  â”‚ users:read        View user profiles              â”‚ â”‚  |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  CRM (plugin)                                           â”‚  |
|        |  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  |
|        |  â”‚  â”‚ crm:deals:*         All deal actions (wildcard)   â”‚ â”‚  |
|        |  â”‚  â”‚ crm:contacts:read   View contacts                 â”‚ â”‚  |
|        |  â”‚  â”‚ crm:contacts:write  Create/edit contacts          â”‚ â”‚  |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  5 permissions total                                    â”‚  |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
+--------+---------------------------------------------------------------+
```

**System role variant** (per FR-023):

```
|        |  ğŸ”’ Tenant Admin                    [System] badge           |
|        |  System Role Â· Cannot be modified                             |
|        |  Full tenant management access.                               |
|        |  [Edit Role] â† HIDDEN   [Delete] â† HIDDEN                   |
```

System roles: No Edit/Delete buttons. "System" badge displayed. Description is read-only. Permission list is read-only (no checkboxes).

**Users tab** (within Role Detail):

```
|        |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
|        |  â”‚  [Permissions]  [Users (8)] â—„                          â”‚  |
|        |  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  [ğŸ” Search users...________]                          â”‚  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  NAME            â”‚ EMAIL                 â”‚ ASSIGNED    â”‚  |
|        |  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  |
|        |  â”‚  Alex Johnson    â”‚ alex@acme.com         â”‚ Jan 20      â”‚  |
|        |  â”‚  Sam Torres      â”‚ sam@acme.com          â”‚ Jan 22      â”‚  |
|        |  â”‚  Jordan Lee      â”‚ jordan@acme.com       â”‚ Feb 01      â”‚  |
|        |  â”‚  ...                                                    â”‚  |
|        |  â”‚                                                         â”‚  |
|        |  â”‚  8 users with this role                                 â”‚  |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
```

#### State Inventory

| State          | Trigger               | Visual Change                                                                                                                       | User Feedback       |
| -------------- | --------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | ------------------- |
| Default        | Role loaded           | Permission list + user tab                                                                                                          | â€”                   |
| Loading        | Initial load          | Skeleton for permissions, skeleton for user list                                                                                    | â€”                   |
| Error          | API failure           | Alert: "Failed to load role details." [Retry]                                                                                       | Error toast         |
| System role    | is_system = true      | Lock icon, "System" badge, no Edit/Delete buttons, description notes "Cannot be modified"                                           | â€”                   |
| Delete confirm | Delete button clicked | Dialog: "Delete '{name}'? This will remove this role from {N} users. This action cannot be undone." [Cancel] [Delete] (destructive) | Confirmation dialog |

#### Interactive Elements

| Element         | Type                 | Action | Outcome                                                       |
| --------------- | -------------------- | ------ | ------------------------------------------------------------- |
| Back to Roles   | Link                 | Click  | Navigate to Role List                                         |
| Edit Role       | Button (secondary)   | Click  | Navigate to Role Editor (edit mode) â€” hidden for system roles |
| Delete          | Button (destructive) | Click  | Confirmation dialog â†’ DELETE /api/v1/roles/:id                |
| Permissions tab | Tab trigger          | Click  | Show permissions panel                                        |
| Users tab       | Tab trigger          | Click  | Show users assigned to this role                              |
| Search users    | Input                | Type   | Filter user list                                              |
| User row        | Table row            | Click  | Navigate to user detail                                       |

#### Accessibility

```
Role: main
Heading hierarchy: h1 "{Role Name}" â†’ h2 "Permissions" / "Users"
Tab order: [1] Back â†’ [2] Edit â†’ [3] Delete â†’ [4] Permissions tab â†’
           [5] Users tab â†’ [6..N] Content elements
Focus trap: Yes â€” on delete confirmation dialog

ARIA:
  System badge: role="status", aria-label="System role, cannot be modified"
  Lock icon: aria-hidden="true" (decorative, badge carries meaning)
  Tab list: role="tablist", aria-label="Role details"
  Tab triggers: role="tab", aria-selected="true/false"
  Tab panels: role="tabpanel", aria-labelledby="tab-{name}"
  Delete dialog: role="alertdialog", aria-labelledby="delete-title", aria-describedby="delete-desc"

Contrast: Same as Role List (per design system tokens) âœ“

Keyboard:
  Tab: Navigate between controls
  Arrow Left/Right: Switch tabs
  Enter: Activate buttons
  Esc: Close delete confirmation dialog
  Delete key: (no action â€” prevent accidental deletion)

Screen reader flow:
  1. "Sales Manager, heading level 1"
  2. "Custom Role, created January 15 2026"
  3. "Role details, tab list, 2 tabs"
  4. "Permissions, tab, selected"
  5. "Core permissions: workspaces:read View workspaces, users:read View user profiles"
  6. "CRM plugin permissions: crm:deals:* All deal actions, ..."
  7. "5 permissions total"
```

---

### Screen 4: User Role Assignment

**Source**: FR-006, FR-018, FR-019 | **Type**: New

This screen appears in two contexts:

1. **Standalone page**: Access Control > Users â€” lists all users with role management.
2. **Dialog**: "Manage Roles" action from a user row â€” opens a dialog for a specific user.

**Standalone page (User list with roles)**:

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  Users & Roles                                               |
| BAR    |  Assign roles to control what users can access               |
|        |                                                               |
|--------|  [ğŸ” Search users..._______________]  [Role â–¾]               |
|        |                                                               |
| Access |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
| Control|  â”‚ USER           â”‚ EMAIL               â”‚ ROLES        â”‚   â”‚  |
|  Roles |  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¤  |
|  Usersâ—„|  â”‚ ğŸ‘¤ Alex Johnsonâ”‚ alex@acme.com       â”‚ [User]       â”‚ âš™ â”‚  |
|  Polici|  â”‚                â”‚                     â”‚ [Sales Mgr]  â”‚   â”‚  |
|        |  â”‚ ğŸ‘¤ Sam Torres  â”‚ sam@acme.com        â”‚ [User]       â”‚ âš™ â”‚  |
|        |  â”‚                â”‚                     â”‚ [CRM Viewer] â”‚   â”‚  |
|        |  â”‚ ğŸ‘¤ Jordan Lee  â”‚ jordan@acme.com     â”‚ [User]       â”‚ âš™ â”‚  |
|        |  â”‚ ğŸ‘¤ Dana Chen   â”‚ dana@acme.com       â”‚ [User]       â”‚ âš™ â”‚  |
|        |  â”‚                â”‚                     â”‚ [Tenant Admin]â”‚  â”‚  |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜  |
|        |                                                               |
|        |  Showing 4 of 40 users                    [â—€ 1 2 3 ... â–¶]   |
+--------+---------------------------------------------------------------+
```

**Role Assignment Dialog** (triggered by âš™ button):

```
+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+
â”‚  Manage Roles: Alex Johnson                          [X] â”‚
â”‚  alex@acme.com                                           â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€ System Roles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ”’ â˜‘ User              Base user access           â”‚  â”‚
â”‚  â”‚    (System role â€” cannot be removed)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€ Custom Roles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â˜‘ Sales Manager        CRM contacts & deals        â”‚  â”‚
â”‚  â”‚ â˜ CRM Viewer           Read-only CRM access        â”‚  â”‚
â”‚  â”‚ â˜ Support Agent         Help desk & tickets         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€ Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ No changes                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚              [ Cancel ]              [ Save Changes ]    â”‚
+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+
```

**When a role is added/removed, the "Changes" section updates**:

```
â”‚  â”Œâ”€ Changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ + Adding: CRM Viewer (+3 permissions)              â”‚  â”‚
â”‚  â”‚   crm:contacts:read, crm:deals:read,              â”‚  â”‚
â”‚  â”‚   crm:reports:read                                 â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚ âˆ’ Removing: Sales Manager (âˆ’5 permissions)         â”‚  â”‚
â”‚  â”‚   âš  Alex will lose access to: crm:deals:write,    â”‚  â”‚
â”‚  â”‚     crm:deals:delete, crm:contacts:write           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
```

#### State Inventory

| State                | Trigger               | Visual Change                                                                                              | User Feedback                   |
| -------------------- | --------------------- | ---------------------------------------------------------------------------------------------------------- | ------------------------------- |
| Default              | Dialog opens          | Current roles checked. Changes section: "No changes"                                                       | â€”                               |
| Loading              | Save clicked          | Save button spinner, checkboxes disabled                                                                   | â€”                               |
| Modified             | Any checkbox toggled  | Changes section shows add/remove diff with permission counts                                               | Green (add) / red (remove) text |
| Error                | Save fails            | Alert in dialog: "Failed to update roles. Please try again."                                               | Error inline                    |
| Success              | Save succeeds         | Toast: "Roles updated for {name}. Changes take effect immediately." Dialog closes. User row badges update. | Success toast                   |
| Empty (no users)     | No users in tenant    | EmptyState: "No team members yet." CTA: "Invite Users"                                                     | â€”                               |
| Role removal warning | Custom role unchecked | Changes section shows lost permissions in orange/red                                                       | Warning styling                 |

#### Interactive Elements

| Element              | Type                | Action | Outcome                                                            |
| -------------------- | ------------------- | ------ | ------------------------------------------------------------------ |
| Search users         | Input               | Type   | Filter user list                                                   |
| Role filter          | Select              | Select | Filter users by assigned role                                      |
| Manage Roles (âš™)     | Button (ghost)      | Click  | Open role assignment dialog for that user                          |
| System role checkbox | Checkbox (disabled) | â€”      | Cannot toggle. Tooltip: "System roles are assigned automatically." |
| Custom role checkbox | Checkbox            | Click  | Toggle role assignment. Updates Changes section.                   |
| Cancel               | Button (secondary)  | Click  | Close dialog, discard changes                                      |
| Save Changes         | Button (primary)    | Click  | POST/DELETE /api/v1/users/:id/roles. Cache flush per FR-019.       |

#### Accessibility

```
Role: dialog (for assignment modal)
Heading hierarchy: h2 "Manage Roles: {userName}"
Tab order: [1] Close (X) â†’ [2] System role checkboxes (disabled) â†’ [3..N] Custom role
           checkboxes â†’ [N+1] Cancel â†’ [N+2] Save Changes
Focus trap: Yes â€” modal dialog

ARIA:
  Dialog: role="dialog", aria-modal="true", aria-labelledby="manage-roles-title"
  System role checkbox: aria-disabled="true", aria-describedby="system-role-hint"
  System role hint: id="system-role-hint", "System role â€” cannot be removed"
  Custom role checkbox: aria-label="{roleName}: {description}"
  Changes section: aria-live="polite", aria-atomic="true"
  Save button: aria-disabled="true" when no changes

Contrast: Same design system tokens âœ“

Keyboard:
  Tab: Navigate checkboxes and buttons
  Space: Toggle checkbox
  Enter: Activate buttons
  Esc: Close dialog (with unsaved changes warning if dirty)

Screen reader flow:
  1. "Manage Roles for Alex Johnson, dialog"
  2. "System Roles, group"
  3. "User, checkbox, checked, disabled, System role cannot be removed"
  4. "Custom Roles, group"
  5. "Sales Manager, CRM contacts and deals, checkbox, checked"
  6. "CRM Viewer, Read-only CRM access, checkbox, not checked"
  7. "Changes: No changes" â†’ (after toggling) "Changes: Adding CRM Viewer, plus 3 permissions"
```

---

### Screen 5: ABAC Policy List

**Source**: FR-007, FR-009, FR-017 | **Type**: New

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  Access Policies                                [+ Create Policy]
| BAR    |  Define fine-grained restrictions beyond role-based access    |
|        |                                                               |
|--------|  [ğŸ” Search policies...______________]  [Effect â–¾] [Source â–¾]  |
|        |                                                               |
| Access |  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
| Control|  â”‚ POLICY NAME        â”‚ RESOURCE    â”‚ EFFECT  â”‚ SOURCE  â”‚  â”‚  |
|  Roles |  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¤  |
|  Users |  â”‚ Sales: own deals   â”‚ crm:deals:* â”‚ [FILTER]â”‚ Tenant  â”‚ â‹®â”‚  |
|  Policiâ—„|  â”‚ No archived data  â”‚ crm:*       â”‚ [DENY]  â”‚ Tenant  â”‚ â‹®â”‚  |
|        |  â”‚ Business hours onlyâ”‚ hr:payroll:* â”‚ [DENY]  â”‚ Plugin  â”‚ ğŸ”’â”‚  |
|        |  â”‚ PII read restrict  â”‚ users:*     â”‚ [FILTER]â”‚ Core    â”‚ ğŸ”’â”‚  |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”˜  |
|        |                                                               |
|        |  4 policies                                                   |
+--------+---------------------------------------------------------------+
```

**Key design decisions**:

- Effect column uses colored badges: `FILTER` in blue (`--status-info`), `DENY` in red (`--destructive`). Per FR-017.
- Source column shows the policy origin (FR-009): Core, Plugin, Super Admin, Tenant Admin.
- Core and Plugin policies have a lock icon â€” they can be viewed but not edited/deleted by tenant admins (per FR-009, FR-015 for overrides).
- Tenant Admin policies have the action menu (â‹®) with Edit, Delete.
- Tenant admins can "override" a plugin policy by creating a tenant-scoped policy with higher priority (FR-015).

#### State Inventory

| State         | Trigger                        | Visual Change                                                                                                             | User Feedback |
| ------------- | ------------------------------ | ------------------------------------------------------------------------------------------------------------------------- | ------------- |
| Default       | Page load, policies exist      | Data table with policy rows                                                                                               | â€”             |
| Loading       | Initial load                   | Skeleton rows                                                                                                             | â€”             |
| Error         | API failure                    | Alert: "Failed to load policies." [Retry]                                                                                 | Error toast   |
| Empty         | No policies exist              | EmptyState: "No access policies yet." Body text explains ABAC purpose. CTA: "Create Your First Policy"                    | â€”             |
| ABAC disabled | Feature flag off (pre-Phase 3) | Info banner: "Attribute-based access policies are coming soon. Roles currently control all access." Create button hidden. | Info banner   |
| Success       | After policy save/delete       | Toast notification. Table refreshes.                                                                                      | Success toast |

#### Interactive Elements

| Element                   | Type             | Action | Outcome                                                                         |
| ------------------------- | ---------------- | ------ | ------------------------------------------------------------------------------- |
| Create Policy             | Button (primary) | Click  | Navigate to Policy Editor                                                       |
| Search input              | Input            | Type   | Filter policies by name/resource                                                |
| Effect filter             | Select           | Select | Filter by DENY / FILTER                                                         |
| Source filter             | Select           | Select | Filter by Core / Plugin / Super Admin / Tenant Admin                            |
| Policy row (tenant-owned) | Table row        | Click  | Navigate to policy detail/edit                                                  |
| Policy row (core/plugin)  | Table row        | Click  | Navigate to policy detail (read-only)                                           |
| Action menu (â‹®)           | Dropdown         | Click  | Edit, Delete (tenant-owned only)                                                |
| Lock icon (core/plugin)   | Icon             | Hover  | Tooltip: "This policy is managed by {source}. Create an override to customize." |

#### Accessibility

```
Role: main
Heading hierarchy: h1 "Access Policies"
Tab order: [1] Search â†’ [2] Effect filter â†’ [3] Source filter â†’ [4] Create Policy â†’
           [5..N] Table rows â†’ [N+1] Pagination
Focus trap: No

ARIA:
  Search: aria-label="Search policies by name or resource"
  Effect badges: aria-label="Effect: FILTER" / "Effect: DENY"
  Lock icon: aria-label="Managed by {source}, read-only"
  DataTable: role="table", aria-label="Access policies list"

Contrast:
  FILTER badge (blue on light bg): --status-info on --background = 4.6:1 âœ“
  DENY badge (red on light bg): --destructive on --background = 5.8:1 âœ“

Keyboard:
  Same as Role List table navigation âœ“

Screen reader flow:
  1. "Access Policies, heading level 1"
  2. "Access policies list, table, 4 rows"
  3. "Row 1: Sales own deals, resource crm:deals:*, effect FILTER, source Tenant Admin, actions available"
  4. "Row 3: Business hours only, resource hr:payroll:*, effect DENY, source Plugin, read-only"
```

---

### Screen 6: ABAC Policy Editor

**Source**: FR-008, FR-014, FR-015, FR-022 | **Type**: New

```
+------------------------------------------------------------------------+  W: 1440px
| â‰¡ Plexica                                           [?] [ğŸ””] [User â–¾] |
+--------+---------------------------------------------------------------+
|        |                                                               |
| SIDE   |  â† Back to Policies                                          |
| BAR    |                                                               |
|        |  Create Policy                                                |
|        |  Define attribute-based access restrictions                   |
|--------|                                                               |
|        |  â”Œâ”€ Policy Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Name *      [Sales team: own deals only_____________]   â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Resource *  [crm:deals:*________________________] â–¾     â”‚ |
|        |  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ |
|        |  â”‚              â”‚ crm:deals:*                 â”‚             â”‚ |
|        |  â”‚              â”‚ crm:contacts:*              â”‚             â”‚ |
|        |  â”‚              â”‚ crm:deals:read              â”‚             â”‚ |
|        |  â”‚              â”‚ crm:contacts:write          â”‚             â”‚ |
|        |  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Effect *    (â—) DENY    (â—‹) FILTER                      â”‚ |
|        |  â”‚              â„¹ DENY: Blocks endpoint access entirely.    â”‚ |
|        |  â”‚              â„¹ FILTER: Restricts which results are       â”‚ |
|        |  â”‚                returned (row-level filtering).           â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Priority    [5_______] (1-100, higher = evaluated first)â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |  â”Œâ”€ Conditions (FR-022) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Match:  (â—) ALL (AND)   (â—‹) ANY (OR)                    â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â”Œâ”€ Condition 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ |
|        |  â”‚  â”‚ [user.teamId     â–¾] [equals    â–¾] [resource.teamId] â”‚ â”‚ |
|        |  â”‚  â”‚                                               [âœ•]   â”‚ â”‚ |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â”Œâ”€ Condition 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ |
|        |  â”‚  â”‚ [resource.status â–¾] [notEquals  â–¾] [archived_____]  â”‚ â”‚ |
|        |  â”‚  â”‚                                               [âœ•]   â”‚ â”‚ |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  â”Œâ”€ NOT Group â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ |
|        |  â”‚  â”‚  â”Œâ”€ Condition 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ |
|        |  â”‚  â”‚  â”‚ [user.role     â–¾] [equals    â–¾] [super_admin] â”‚ â”‚ â”‚ |
|        |  â”‚  â”‚  â”‚                                          [âœ•]  â”‚ â”‚ â”‚ |
|        |  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ |
|        |  â”‚  â”‚                                            [âœ• NOT]â”‚ â”‚ |
|        |  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  [+ Add Condition]  [+ Add Group (AND)]                  â”‚ |
|        |  â”‚  [+ Add Group (OR)] [+ Add NOT]                          â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  Conditions: 3/20 used Â· Depth: 2/5 levels               â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |  â”Œâ”€ Summary (plain English) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” |
|        |  â”‚                                                          â”‚ |
|        |  â”‚  "This policy will FILTER results on crm:deals:*        â”‚ |
|        |  â”‚   where ALL of the following are true:                   â”‚ |
|        |  â”‚   â€¢ The user's team matches the resource's team          â”‚ |
|        |  â”‚   â€¢ The resource status is not 'archived'                â”‚ |
|        |  â”‚   â€¢ The user is NOT a super admin"                       â”‚ |
|        |  â”‚                                                          â”‚ |
|        |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ |
|        |                                                               |
|        |         [ Cancel ]                        [ Save Policy ]    |
+--------+---------------------------------------------------------------+
```

**Key design decisions**:

- Condition builder (FR-022): Supports nested AND/OR/NOT via button-based add (not drag-and-drop for v1 â€” accessibility risk). Each condition has three fields: attribute (with autocomplete), operator (dropdown), value (text or attribute reference).
- NOT groups wrap a single condition or sub-group with inverted logic. Visually distinguished by dashed border and "NOT" label.
- **Condition limits** (FR-008): A usage indicator ("3/20 conditions used Â· Depth: 2/5 levels") is displayed below the add buttons. When approaching limits (â‰¥18 conditions or depth â‰¥4), the indicator turns orange (`--status-warning`). At the limit, add buttons are disabled with a tooltip: "Condition limit reached (20/20)." / "Maximum nesting depth reached (5/5)."
- Plain-English summary auto-generated from condition tree. Read-only. Helps non-technical admins verify policy intent.
- Resource field has autocomplete from registered permissions (FR-011, FR-012).
- Effect radio buttons have inline explanatory text per FR-017.
- Priority field determines evaluation order (higher = first).

#### State Inventory

| State              | Trigger                                  | Visual Change                                                                                                   | User Feedback    |
| ------------------ | ---------------------------------------- | --------------------------------------------------------------------------------------------------------------- | ---------------- |
| Default (create)   | "Create Policy" clicked                  | Empty form                                                                                                      | â€”                |
| Default (edit)     | "Edit" clicked on tenant policy          | Form pre-filled                                                                                                 | â€”                |
| Loading            | Save clicked                             | Save button spinner, form disabled                                                                              | â€”                |
| Error (validation) | Missing required fields or no conditions | Red borders on missing fields. Error: "At least one condition is required."                                     | Inline errors    |
| Error (API)        | Save fails                               | Alert: "Failed to save policy."                                                                                 | Error toast      |
| Error (limit)      | JSONB payload exceeds 64 KB              | Alert below conditions: "Policy conditions exceed the maximum size (64 KB). Simplify conditions to save."       | Inline error     |
| Success            | Save succeeds                            | Toast: "Policy created/updated." Redirect to Policy List.                                                       | Success toast    |
| Condition warning  | Mismatched operator/attribute type       | Orange warning below condition row                                                                              | Advisory warning |
| Near limit         | â‰¥18 conditions or depth â‰¥4               | Usage indicator turns orange. "Approaching limit" tooltip on indicator.                                         | Warning styling  |
| At limit           | 20 conditions or depth 5 reached         | Add buttons disabled. Usage indicator red. Tooltip: "Condition/depth limit reached."                            | Disabled buttons |
| Read-only          | Viewing a core/plugin policy             | All fields disabled. Banner: "This is a {source} policy and cannot be edited. Create an override to customize." | Info banner      |

#### Interactive Elements

| Element                  | Type                    | Action      | Outcome                                                        |
| ------------------------ | ----------------------- | ----------- | -------------------------------------------------------------- |
| Back to Policies         | Link                    | Click       | Navigate to Policy List (unsaved warning if dirty)             |
| Name input               | Input                   | Type        | Required, free text                                            |
| Resource input           | Combobox (autocomplete) | Type/Select | Shows matching resource patterns from registered permissions   |
| Effect radio             | Radio group             | Select      | DENY or FILTER (per FR-017)                                    |
| Priority input           | Number input            | Type        | Integer 1-100                                                  |
| Match radio (ALL/ANY)    | Radio group             | Select      | Sets root combinator of condition tree                         |
| Attribute dropdown       | Select (combobox)       | Select      | Namespace-grouped: user._, resource._, environment._, tenant._ |
| Operator dropdown        | Select                  | Select      | equals, notEquals, contains, in, greaterThan, lessThan, exists |
| Value input              | Input                   | Type        | Free text or attribute reference (e.g., resource.teamId)       |
| Remove condition (âœ•)     | Button (ghost)          | Click       | Removes condition row                                          |
| Add Condition            | Button (secondary)      | Click       | Adds new condition row at current nesting level                |
| Add Group (AND)          | Button (secondary)      | Click       | Adds nested AND group                                          |
| Add Group (OR)           | Button (secondary)      | Click       | Adds nested OR group                                           |
| Add NOT                  | Button (secondary)      | Click       | Wraps next condition in NOT                                    |
| Remove NOT group (âœ• NOT) | Button (ghost)          | Click       | Unwraps NOT, keeps inner condition                             |
| Cancel                   | Button (secondary)      | Click       | Navigate back (unsaved warning)                                |
| Save Policy              | Button (primary)        | Click       | POST/PUT /api/v1/policies                                      |

#### Accessibility

```
Role: form
Heading hierarchy: h1 "Create Policy" â†’ h2 "Policy Details" â†’ h2 "Conditions" â†’ h2 "Summary"
Tab order: [1] Back â†’ [2] Name â†’ [3] Resource â†’ [4] Effect (DENY) â†’ [5] Effect (FILTER) â†’
           [6] Priority â†’ [7] Match (ALL) â†’ [8] Match (ANY) â†’
           [9..N] Condition fields (attribute â†’ operator â†’ value â†’ remove) per row â†’
           [N+1..] Add buttons â†’ [N+5] Cancel â†’ [N+6] Save
Focus trap: No (full page form)

ARIA:
  Effect radio group: role="radiogroup", aria-label="Policy effect"
  Effect option: role="radio", aria-describedby="effect-{value}-desc"
  Match radio group: role="radiogroup", aria-label="Condition matching mode"
  Condition group: role="group", aria-label="Condition {N}"
  NOT group: role="group", aria-label="NOT group"
  Attribute select: aria-label="Attribute for condition {N}"
  Operator select: aria-label="Operator for condition {N}"
  Value input: aria-label="Value for condition {N}"
  Remove button: aria-label="Remove condition {N}"
  Summary section: aria-live="polite" (updates when conditions change)
  Resource combobox: role="combobox", aria-autocomplete="list", aria-expanded="true/false"

Contrast:
  Effect descriptions (muted text): --muted-foreground on --card = 4.7:1 âœ“
  NOT group border (dashed): --border on --card = 3:1 âœ“
  Condition card on page: --card on --background = distinct âœ“

Keyboard:
  Tab: Move between all interactive elements
  Space: Select radio button
  Enter: Activate buttons, select autocomplete option
  Esc: Close autocomplete dropdown
  Arrow Up/Down: Navigate autocomplete options, move between conditions

Screen reader flow:
  1. "Create Policy, heading level 1"
  2. "Policy Details, heading level 2"
  3. "Name, required, text input"
  4. "Resource, required, combobox"
  5. "Policy effect, radio group: DENY selected, Blocks endpoint access entirely"
  6. "Conditions, heading level 2"
  7. "Condition matching mode, radio group: ALL AND selected"
  8. "Condition 1, group: Attribute user.teamId, operator equals, value resource.teamId"
  9. "NOT group: Condition 3: Attribute user.role, operator equals, value super_admin"
  10. "Summary: This policy will FILTER results on crm deals..."
```

---

## 4. Component Inventory

### Component: PermissionGroupAccordion

| Property    | Value                                                                               |
| ----------- | ----------------------------------------------------------------------------------- |
| Type        | Accordion / Collapsible group                                                       |
| Used on     | Role Editor (Screen 2), Role Detail (Screen 3)                                      |
| FR coverage | FR-020                                                                              |
| Existing?   | No (new) â€” extends existing Accordion pattern but with permission-specific behavior |

**Variants**: editable (with checkboxes), readonly (permission list only)

**Props**:

- `source`: string â€” "Core" or plugin name
- `permissions`: Permission[] â€” permissions in this group
- `selectedIds`: Set<string> â€” currently selected permission IDs
- `onToggle(permissionId: string)`: handler
- `readonly`: boolean â€” disables checkboxes for detail view
- `count`: { selected: number; total: number }

**States**:

| State     | Visual                                                        | Aria                          |
| --------- | ------------------------------------------------------------- | ----------------------------- |
| Collapsed | Header with source name + count badge, chevron pointing right | aria-expanded="false"         |
| Expanded  | Header + permission list visible, chevron pointing down       | aria-expanded="true"          |
| Disabled  | All checkboxes grayed (system role view)                      | aria-disabled="true" on group |

**Keyboard behavior**:

- `Tab`: Focus group header
- `Enter` / `Space`: Toggle expand/collapse
- `Arrow Down`: Move to first checkbox when expanded

---

### Component: WildcardPermissionRow

| Property    | Value                         |
| ----------- | ----------------------------- |
| Type        | Checkbox with nested children |
| Used on     | Role Editor (Screen 2)        |
| FR coverage | FR-021                        |
| Existing?   | No (new)                      |

**Props**:

- `wildcardPermission`: Permission â€” the wildcard (e.g., `crm:deals:*`)
- `subPermissions`: Permission[] â€” individual permissions under the wildcard
- `selectedIds`: Set<string>
- `onToggle(permissionId: string)`: handler
- `onToggleWildcard(wildcardId: string)`: handler

**Behavior**:

- Checking wildcard: all sub-permissions auto-checked (FR-021)
- Unchecking any sub-permission: wildcard auto-unchecked (FR-021)
- Checking all sub-permissions individually: wildcard auto-checked
- Wildcard row is visually distinguished with âœ¦ icon and indented sub-rows with tree lines (â”œ â””)

**States**:

| State                   | Visual                                             | Aria                             |
| ----------------------- | -------------------------------------------------- | -------------------------------- |
| None selected           | Wildcard unchecked, all sub unchecked              | â€”                                |
| Wildcard checked        | Wildcard checked with âœ¦ icon, all sub checked      | aria-checked="true" for all      |
| Partial (indeterminate) | Wildcard shows indeterminate (â€”), some sub checked | aria-checked="mixed" on wildcard |
| Hover                   | Row background changes to --muted                  | â€”                                |

**Keyboard behavior**:

- `Tab`: Focus wildcard checkbox, then sub-checkboxes
- `Space`: Toggle checkbox

---

### Component: ConditionBuilder

| Property    | Value                         |
| ----------- | ----------------------------- |
| Type        | Form / Recursive tree editor  |
| Used on     | ABAC Policy Editor (Screen 6) |
| FR coverage | FR-008, FR-022                |
| Existing?   | No (new)                      |

**Props**:

- `conditions`: ConditionTree â€” nested AND/OR/NOT structure
- `onChange(conditions: ConditionTree)`: handler
- `attributes`: AttributeDefinition[] â€” available attributes with namespaces
- `readonly`: boolean â€” for viewing core/plugin policies
- `maxConditions`: number â€” maximum conditions allowed (default: 20, per FR-008)
- `maxDepth`: number â€” maximum nesting depth allowed (default: 5, per FR-008)

**Sub-components**:

- `ConditionRow`: Single condition (attribute, operator, value)
- `ConditionGroup`: AND/OR wrapper with nested conditions
- `NotGroup`: NOT wrapper (dashed border) with single inner condition/group
- `ConditionLimitIndicator`: Shows "{n}/20 conditions used Â· Depth: {d}/5 levels"

**States**:

| State      | Visual                                        | Aria                                 |
| ---------- | --------------------------------------------- | ------------------------------------ |
| Default    | Empty builder with "Add Condition" button     | â€”                                    |
| Populated  | Condition cards with nesting indicators       | role="group" per level               |
| Error      | Missing fields highlighted red                | aria-invalid="true" on empty fields  |
| Read-only  | All inputs disabled, no add/remove buttons    | aria-disabled="true"                 |
| Warning    | Orange icon + text below mismatched condition | role="alert"                         |
| Near limit | Limit indicator turns orange (â‰¥18/20 or â‰¥4/5) | aria-live="polite" announces warning |
| At limit   | Add buttons disabled; limit indicator red     | aria-disabled="true" on add buttons  |

**Keyboard behavior**:

- `Tab`: Navigate between condition fields and buttons
- `Enter`: Add condition/group when focused on add button
- `Delete` / `Backspace`: (no action on conditions â€” must use âœ• button for safety)
- `Esc`: Blur current field

---

### Component: PolicySummary

| Property    | Value                                  |
| ----------- | -------------------------------------- |
| Type        | Read-only text block                   |
| Used on     | ABAC Policy Editor (Screen 6)          |
| FR coverage | FR-022 (implicit â€” aids understanding) |
| Existing?   | No (new)                               |

**Props**:

- `effect`: "DENY" | "FILTER"
- `resource`: string
- `conditions`: ConditionTree

**Behavior**: Auto-generates plain-English description of the policy from the condition tree. Updates live as conditions change.

**States**:

| State   | Visual                                       | Aria               |
| ------- | -------------------------------------------- | ------------------ |
| Default | Summary text in a bordered card              | aria-live="polite" |
| Empty   | "Add conditions above to see a summary."     | â€”                  |
| Complex | Multi-line bullet list for nested conditions | â€”                  |

---

### Component: RoleAssignmentDialog

| Property    | Value                                        |
| ----------- | -------------------------------------------- |
| Type        | Dialog / Modal                               |
| Used on     | User Role Assignment (Screen 4)              |
| FR coverage | FR-006, FR-018, FR-019                       |
| Existing?   | No (new) â€” extends existing Dialog component |

**Props**:

- `userId`: string
- `userName`: string
- `currentRoles`: Role[]
- `availableRoles`: Role[]
- `onSave(addedRoleIds: string[], removedRoleIds: string[])`: handler

**States**:

| State    | Visual                                   | Aria                                  |
| -------- | ---------------------------------------- | ------------------------------------- |
| Default  | Current roles checked. "No changes"      | role="dialog", aria-modal="true"      |
| Modified | Changes section shows diff               | aria-live="polite" on changes section |
| Loading  | Save button spinner, checkboxes disabled | aria-busy="true" on dialog            |
| Error    | Inline alert in dialog                   | role="alert"                          |
| Success  | Dialog closes, toast shown               | â€”                                     |

**Keyboard behavior**:

- `Tab`: Navigate checkboxes and buttons
- `Space`: Toggle role checkbox
- `Enter`: Activate buttons
- `Esc`: Close dialog (unsaved changes warning if modified)

---

### Component: EffectBadge

| Property    | Value                                                           |
| ----------- | --------------------------------------------------------------- |
| Type        | Badge                                                           |
| Used on     | Policy List (Screen 5), Policy Editor (Screen 6)                |
| FR coverage | FR-017                                                          |
| Existing?   | Yes (reuses `Badge` from `@plexica/ui`) with new color variants |

**Variants**:

- `DENY`: Uses `--destructive` background. Text: "DENY".
- `FILTER`: Uses `--status-info` background. Text: "FILTER".

**States**:

| State  | Visual                      | Aria                        |
| ------ | --------------------------- | --------------------------- |
| DENY   | Red background, white text  | aria-label="Effect: DENY"   |
| FILTER | Blue background, white text | aria-label="Effect: FILTER" |

---

### Component: SystemRoleBadge

| Property    | Value                                                                         |
| ----------- | ----------------------------------------------------------------------------- |
| Type        | Badge + Icon                                                                  |
| Used on     | Role List (Screen 1), Role Detail (Screen 3), User Role Assignment (Screen 4) |
| FR coverage | FR-023                                                                        |
| Existing?   | No (new) â€” uses `Badge` from `@plexica/ui` + `Lock` icon from Lucide          |

**Visual**: Lock icon (ğŸ”’) + "System" text badge in `--muted` background.

**States**:

| State   | Visual                    | Aria                                                        |
| ------- | ------------------------- | ----------------------------------------------------------- |
| Default | Lock icon + "System" text | role="status", aria-label="System role, cannot be modified" |

---

### Reused `@plexica/ui` Components

| Component                                                                | Usage in this feature                                          |
| ------------------------------------------------------------------------ | -------------------------------------------------------------- |
| `Button`                                                                 | All CTAs (Create Role, Save, Cancel, Delete)                   |
| `Input`                                                                  | Name, description, search fields                               |
| `Checkbox`                                                               | Permission toggles, role assignment toggles                    |
| `Badge`                                                                  | Role type (System/Custom), effect (DENY/FILTER), source labels |
| `Card`, `CardHeader`, `CardContent`                                      | Form sections, summary panels                                  |
| `DataTable`                                                              | Role List, User List, Policy List                              |
| `Dialog`, `DialogContent`, `DialogHeader`, `DialogTitle`, `DialogFooter` | Role assignment, delete confirmation                           |
| `Toast`                                                                  | Success/error notifications                                    |
| `Tooltip`                                                                | Disabled button explanations, lock icon descriptions           |
| `Tabs`, `TabsList`, `TabsTrigger`, `TabsContent`                         | Role Detail (Permissions/Users tabs)                           |
| `Select`                                                                 | Filters (Source, Type, Effect)                                 |
| `Skeleton`                                                               | Loading states                                                 |
| `EmptyState`                                                             | No roles, no policies, no users                                |
| `Alert`                                                                  | Error banners, info banners                                    |
| `Pagination`                                                             | Role List, User List                                           |
| `Breadcrumbs`                                                            | â€” (not needed; using back links for simpler hierarchy)         |
| `Separator`                                                              | Dividers between sections                                      |
| `Textarea`                                                               | Role description (multi-line)                                  |
| `Spinner`                                                                | Button loading states                                          |
| `StatusBadge`                                                            | Adapted for effect and source badges                           |

---

## 5. Design Tokens

> Reference: `.forge/ux/design-system.md`

### Tokens Used From Existing Design System

| Token                  | Value               | Usage in this feature                               |
| ---------------------- | ------------------- | --------------------------------------------------- |
| `--background`         | #FFFFFF / #0A0A0A   | Page background                                     |
| `--foreground`         | #0A0A0A / #FAFAFA   | All body text                                       |
| `--card`               | #FFFFFF / #111111   | Form sections, condition cards                      |
| `--muted`              | #F4F4F5 / #27272A   | System badge background, disabled states            |
| `--muted-foreground`   | #71717A / #A1A1AA   | Secondary text, permission descriptions             |
| `--primary`            | #0066CC / #3B82F6   | Primary buttons, active tab indicator               |
| `--primary-foreground` | #FFFFFF / #FFFFFF   | Text on primary buttons                             |
| `--destructive`        | #DC2626 / #EF4444   | Delete buttons, DENY badge, error states            |
| `--border`             | #E4E4E7 / #27272A   | Card borders, condition row borders                 |
| `--ring`               | #0066CC / #3B82F6   | Focus rings on all interactive elements             |
| `--status-info`        | #2563EB / #60A5FA   | FILTER badge background                             |
| `--status-warning`     | #D97706 / #F59E0B   | Condition mismatch warnings                         |
| `--font-size-xs`       | 12px                | Permission key text (monospace), condition labels   |
| `--font-size-sm`       | 14px                | Table cells, badge text, permission descriptions    |
| `--font-size-base`     | 16px                | Form inputs, body text                              |
| `--font-size-lg`       | 18px                | Card section headings                               |
| `--font-size-xl`       | 20px                | Screen headings (h2)                                |
| `--font-size-2xl`      | 24px                | Page titles (h1)                                    |
| `--font-mono`          | JetBrains Mono, ... | Permission keys, resource patterns, attribute names |
| `--space-2`            | 8px                 | Checkbox-to-label gap, badge padding                |
| `--space-3`            | 12px                | Compact card padding (condition rows)               |
| `--space-4`            | 16px                | Default card padding, form field spacing            |
| `--space-6`            | 24px                | Section spacing                                     |
| `--space-8`            | 32px                | Between major page sections                         |
| `--radius-sm`          | 4px                 | Badges, checkboxes                                  |
| `--radius-md`          | 6px                 | Buttons, cards, condition rows                      |
| `--radius-lg`          | 8px                 | Dialog, main content panels                         |
| `--shadow-sm`          | (see design system) | Condition row cards                                 |
| `--shadow-md`          | (see design system) | Form section cards                                  |
| `--shadow-lg`          | (see design system) | Dialog overlay                                      |
| `--transition-fast`    | 150ms ease-in-out   | Checkbox state changes, hover effects               |
| `--transition-normal`  | 200ms ease-in-out   | Accordion expand/collapse, tab switching            |

### New Tokens Introduced

| Token                    | Light     | Dark      | Usage                                                   |
| ------------------------ | --------- | --------- | ------------------------------------------------------- |
| `--condition-not-border` | `#D97706` | `#F59E0B` | Dashed border for NOT groups in condition builder       |
| `--condition-not-bg`     | `#FFFBEB` | `#1C1917` | Subtle background for NOT groups                        |
| `--permission-tree-line` | `#D4D4D8` | `#3F3F46` | Tree connector lines (â”œ â””) for wildcard sub-permissions |

---

## 6. Accessibility Summary

| Screen               | WCAG 2.1 AA  | Notes                                                                                           |
| -------------------- | ------------ | ----------------------------------------------------------------------------------------------- |
| Role List            | âœ… Compliant | DataTable with keyboard navigation, system role status via aria-label                           |
| Role Editor          | âœ… Compliant | Accordion groups with aria-expanded, checkbox states, wildcard indeterminate, aria-live summary |
| Role Detail          | âœ… Compliant | Tab navigation with arrow keys, system role read-only state                                     |
| User Role Assignment | âœ… Compliant | Dialog with focus trap, aria-modal, live changes section, disabled system role explanation      |
| ABAC Policy List     | âœ… Compliant | Effect badges with aria-label (not color-only), lock icon descriptions                          |
| ABAC Policy Editor   | âœ… Compliant | Condition builder with aria-labels per field, live summary, radio groups with descriptions      |

**Accessibility features across all screens**:

- All interactive elements have visible focus indicators (2px solid `--ring`)
- Color is never the sole indicator of meaning (badges always have text labels)
- All form inputs have visible labels (not placeholder-only)
- Error messages identify the specific field and describe the issue
- Status changes announced via `aria-live="polite"`
- Tab order follows visual order (left-to-right, top-to-bottom)
- Keyboard navigation: Enter/Space for actions, Esc for dismissal, Arrow keys for lists/tabs
- Screen reader announcements for all state changes
- Text resizable to 200% without horizontal scrolling (tested at each breakpoint)
- Sofia's persona (low vision, 150% zoom) accommodated: no horizontal scroll at 150% on 1024px+

**Open accessibility issues**:

- None

---

## 7. Open Questions

| #   | Question                                               | Impact | Owner |
| --- | ------------------------------------------------------ | ------ | ----- |
| â€”   | No open questions. All design decisions traced to FRs. | â€”      | â€”     |

---

## 8. Cross-References

| Artifact                    | Path                                             |
| --------------------------- | ------------------------------------------------ |
| Feature spec                | `.forge/specs/003-authorization/spec.md`         |
| User journeys               | `.forge/specs/003-authorization/user-journey.md` |
| Design system               | `.forge/ux/design-system.md`                     |
| Constitution (UX standards) | `.forge/constitution.md` Art. 1.3                |
| Authentication spec         | `.forge/specs/002-authentication/spec.md`        |
| Multi-tenancy spec          | `.forge/specs/001-multi-tenancy/spec.md`         |
| Plugin system spec          | `.forge/specs/004-plugin-system/spec.md`         |
