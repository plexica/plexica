// Prisma schema for Plexica
// Documentation: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  schemas  = ["core"]
}

// ============================================================================
// CORE SCHEMA - Global data (tenant registry, plugins, super admins)
// ============================================================================

enum TenantStatus {
  PROVISIONING
  ACTIVE
  SUSPENDED
  PENDING_DELETION
  DELETED

  @@schema("core")
}

model Tenant {
  id                   String       @id @default(uuid())
  slug                 String       @unique
  name                 String
  status               TenantStatus @default(PROVISIONING)
  settings             Json         @default("{}")
  theme                Json         @default("{}")
  translationOverrides Json         @default("{}") @map("translation_overrides")
  defaultLocale        String       @default("en") @map("default_locale")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  plugins       TenantPlugin[]
  ratings       PluginRating[]
  installations PluginInstallation[]

  @@index([defaultLocale], map: "idx_tenants_default_locale")
  @@map("tenants")
  @@schema("core")
}

enum PluginStatus {
  DRAFT // Plugin is being developed
  PENDING_REVIEW // Submitted for review
  PUBLISHED // Available in marketplace
  DEPRECATED // No longer recommended
  REJECTED // Rejected during review

  @@schema("core")
}

model Plugin {
  id        String       @id
  name      String
  version   String // Current/latest version
  manifest  Json
  status    PluginStatus @default(DRAFT)
  
  // Marketplace fields
  description   String?
  longDescription String? @map("long_description") // Detailed description
  category      String   @default("other")
  author        String?
  authorEmail   String?  @map("author_email")
  homepage      String?
  repository    String?
  license       String?
  icon          String?  // Icon URL
  screenshots   String[] @default([]) // Array of screenshot URLs
  demoUrl       String?  @map("demo_url") // Demo/video URL
  
  // Statistics
  averageRating Float    @default(0) @map("average_rating")
  ratingCount   Int      @default(0) @map("rating_count")
  downloadCount Int      @default(0) @map("download_count")
  installCount  Int      @default(0) @map("install_count")
  
  // Publishing
  publishedAt   DateTime? @map("published_at")
  rejectedAt    DateTime? @map("rejected_at")
  rejectionReason String? @map("rejection_reason")
  
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  tenantPlugins TenantPlugin[]
  versions      PluginVersion[]
  ratings       PluginRating[]
  installations PluginInstallation[]

  @@index([status])
  @@index([category])
  @@index([averageRating])
  @@map("plugins")
  @@schema("core")
}

model TenantPlugin {
  tenantId      String
  pluginId      String
  enabled       Boolean  @default(true)
  configuration Json     @default("{}")
  installedAt   DateTime @default(now()) @map("installed_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@id([tenantId, pluginId])
  @@map("tenant_plugins")
  @@schema("core")
}

// ============================================================================
// PLUGIN MARKETPLACE - Versions, Ratings, Installations (M2.4)
// ============================================================================

// Plugin Versions (semver versioning)
model PluginVersion {
  id             String   @id @default(uuid())
  pluginId       String   @map("plugin_id")
  version        String   // Semantic version (e.g., 1.2.3)
  changelog      String?  // Release notes
  manifest       Json     // Full plugin manifest for this version
  assetUrl       String?  @map("asset_url") // CDN URL for plugin bundle
  downloadCount  Int      @default(0) @map("download_count")
  isLatest       Boolean  @default(false) @map("is_latest") // Only one version should be latest
  publishedAt    DateTime @default(now()) @map("published_at")
  createdAt      DateTime @default(now()) @map("created_at")
  
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  
  @@unique([pluginId, version])
  @@index([pluginId])
  @@index([isLatest])
  @@map("plugin_versions")
  @@schema("core")
}

// Plugin Ratings & Reviews
model PluginRating {
  id          String   @id @default(uuid())
  pluginId    String   @map("plugin_id")
  tenantId    String   @map("tenant_id")
  userId      String   @map("user_id") // User who rated
  rating      Int      // 1-5 stars
  review      String?  // Optional review text
  helpful     Int      @default(0) // Helpful votes count
  notHelpful  Int      @default(0) @map("not_helpful") // Not helpful votes count
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([pluginId, tenantId, userId])
  @@index([pluginId])
  @@index([tenantId])
  @@index([rating])
  @@map("plugin_ratings")
  @@schema("core")
}

// Plugin Installation Tracking
model PluginInstallation {
  id           String   @id @default(uuid())
  pluginId     String   @map("plugin_id")
  version      String   // Installed version
  tenantId     String   @map("tenant_id")
  installedBy  String   @map("installed_by") // User ID who installed
  installedAt  DateTime @default(now()) @map("installed_at")
  uninstalledAt DateTime? @map("uninstalled_at")
  
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([pluginId])
  @@index([tenantId])
  @@index([installedAt])
  @@map("plugin_installations")
  @@schema("core")
}

model SuperAdmin {
  id         String   @id @default(uuid())
  keycloakId String   @unique @map("keycloak_id")
  email      String   @unique
  name       String?
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("super_admins")
  @@schema("core")
}

// ============================================================================
// SERVICE REGISTRY - For Plugin-to-Plugin Communication (M2.3)
// ============================================================================

enum ServiceStatus {
  HEALTHY
  DEGRADED
  UNAVAILABLE

  @@schema("core")
}

// Registered plugin services
model PluginService {
  id          String        @id @default(uuid())
  pluginId    String        @map("plugin_id")
  tenantId    String        @map("tenant_id")
  serviceName String        @map("service_name") // e.g., "crm.contacts", "analytics.metrics"
  version     String
  baseUrl     String?       @map("base_url") // For external services
  status      ServiceStatus @default(HEALTHY)
  metadata    Json          @default("{}") // Additional service metadata
  lastSeenAt  DateTime      @default(now()) @map("last_seen_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  endpoints PluginServiceEndpoint[]

  @@unique([tenantId, pluginId, serviceName])
  @@index([tenantId, status])
  @@index([pluginId])
  @@map("plugin_services")
  @@schema("core")
}

// Service endpoints (API methods)
model PluginServiceEndpoint {
  id          String   @id @default(uuid())
  serviceId   String   @map("service_id")
  method      String // GET, POST, PUT, DELETE, PATCH
  path        String // /api/contacts/:id
  description String?
  permissions Json     @default("[]") // Required permissions
  metadata    Json     @default("{}") // Schema, rate limits, etc.
  createdAt   DateTime @default(now()) @map("created_at")

  service PluginService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, method, path])
  @@index([serviceId])
  @@map("plugin_service_endpoints")
  @@schema("core")
}

// Plugin dependencies (for resolution)
model PluginDependency {
  id                String   @id @default(uuid())
  pluginId          String   @map("plugin_id")
  dependsOnPluginId String   @map("depends_on_plugin_id")
  version           String // Semver constraint (e.g., "^1.0.0")
  required          Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at")

  @@unique([pluginId, dependsOnPluginId])
  @@index([pluginId])
  @@index([dependsOnPluginId])
  @@map("plugin_dependencies")
  @@schema("core")
}

// Shared data between plugins (namespaced key-value store)
model SharedPluginData {
  id        String    @id @default(uuid())
  tenantId  String    @map("tenant_id")
  namespace String // e.g., "crm.analytics.sync"
  key       String
  value     Json
  ownerId   String    @map("owner_id") // Plugin ID that owns this data
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  @@unique([tenantId, namespace, key])
  @@index([tenantId, namespace])
  @@index([ownerId])
  @@index([expiresAt])
  @@map("shared_plugin_data")
  @@schema("core")
}

// ============================================================================
// TENANT SCHEMA TEMPLATE
// Note: These models are templates. Each tenant gets its own schema
// dynamically created at provisioning time (e.g., tenant_acme_corp)
// ============================================================================

// Workspace Role Enum
enum WorkspaceRole {
  ADMIN
  MEMBER
  VIEWER

  @@schema("core") // Template in core, replicated per tenant
}

// User Model (in tenant schema)
model User {
  id         String   @id @default(uuid())
  keycloakId String   @unique @map("keycloak_id")
  email      String   @unique
  firstName  String?  @map("first_name")
  lastName   String?  @map("last_name")
  avatar     String?
  locale     String   @default("en")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  workspaceMemberships WorkspaceMember[]
  teamsOwned           Team[]            @relation("TeamOwner")
  invitedBy            WorkspaceMember[] @relation("InvitedBy")

  @@map("users")
  @@schema("core") // Template - will be in tenant schemas
}

// Workspace Model (in tenant schema)
model Workspace {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  slug        String
  name        String
  description String?
  settings    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  members   WorkspaceMember[]
  teams     Team[]
  resources WorkspaceResource[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("workspaces")
  @@schema("core") // Template - will be in tenant schemas
}

// Workspace Member Model (in tenant schema)
model WorkspaceMember {
  workspaceId String        @map("workspace_id")
  userId      String        @map("user_id")
  role        WorkspaceRole
  invitedBy   String        @map("invited_by")
  joinedAt    DateTime      @default(now()) @map("joined_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  inviter   User      @relation("InvitedBy", fields: [invitedBy], references: [id])

  @@id([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
  @@map("workspace_members")
  @@schema("core") // Template - will be in tenant schemas
}

// Workspace Resource Model (for cross-workspace resource tracking)
model WorkspaceResource {
  id           String   @id @default(uuid())
  workspaceId  String   @map("workspace_id")
  resourceType String   @map("resource_type")
  resourceId   String   @map("resource_id")
  createdAt    DateTime @default(now()) @map("created_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, resourceType, resourceId])
  @@index([workspaceId])
  @@index([resourceType, resourceId])
  @@map("workspace_resources")
  @@schema("core") // Template - will be in tenant schemas
}

// Team Model (in tenant schema) - Updated with workspace relationship
model Team {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  name        String
  description String?
  ownerId     String   @map("owner_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner     User      @relation("TeamOwner", fields: [ownerId], references: [id])

  @@index([workspaceId])
  @@index([ownerId])
  @@map("teams")
  @@schema("core") // Template - will be in tenant schemas
}
